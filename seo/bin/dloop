#!/bin/bash

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

source $DIR/utils

#check parameters
if [ $# -ne 3 ]; then
    echo "This routine obtains dark calibration frames"
    echo "Usage: dloop <number of frames> <exposure time in seconds> <binning>"
    exit 1
fi

NUM_DARKS=$1
EXPOSURE_SEC=$2
BINNING=$3
COUNT=0

#not really necessary, but why not
pfilter clear

#get darks; use same exposure as for images
alert "Taking $NUM_DARKS dark frames (bin=$BINNING, time=$EXPOSURE_SEC)..."

#check ccd status before starting
checkCCDTemp
for (( i=1; i<=$NUM_DARKS; i++ ))
do
  getImage $EXPOSURE_SEC $BINNING dark `date -u +"%Y%m%d.%H%M%S%3N"`.`printf "%03d" $COUNT`.dark.$BINNING.$EXPOSURE_SEC.fits
  if [ $SUCCESS -eq 1 ]
  then
    COUNT=$((COUNT+1))
  fi
done

alert "Dark frame sequence complete. Obtained $COUNT dark frames."